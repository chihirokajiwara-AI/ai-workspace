#!/bin/bash
set -eo pipefail

ORG="aesthetic-inc"
DEV="$HOME/dev"
JOURNAL="$DEV/dev-journal"
SESSION_FLAG="$HOME/.devos_active"

die(){ echo "❌ $*" >&2; exit 1; }
ok(){ echo "✅ $*"; }
warn(){ echo "⚠️  $*"; }

need(){ command -v "$1" >/dev/null 2>&1 || die "$1 が必要です"; }

now(){ TZ=Asia/Tokyo date +"%Y-%m-%d_%H-%M-%S"; }

ensure_journal(){
  mkdir -p "$DEV"
  if [ ! -d "$JOURNAL/.git" ]; then
    cd "$DEV"
    gh repo clone "$ORG/dev-journal" "$JOURNAL" || die "dev-journal clone失敗"
  fi
  cd "$JOURNAL"
  git pull --rebase 2>/dev/null || true
  mkdir -p state logs snapshots
  [ -f state/ACTIVE_SESSIONS.json ] || echo '{"sessions":[]}' > state/ACTIVE_SESSIONS.json
}

journal_push(){
  cd "$JOURNAL"
  git add -A
  git commit -m "session: update" 2>/dev/null || true
  git push || die "journal push失敗（保存されていない）"
}

usage(){
  cat <<USAGE
DevOS v1.3 FINAL

Start:
  dev up 1     ← 毎朝これだけ

End:
  dev stop     ← 絶対これだけ
USAGE
}

cmd_list(){
  need jq; ensure_journal
  echo "=== Sessions ==="
  jq -r '.sessions[:10] | to_entries[] |
    "\(.key+1)) \(.value.timestamp)  \(.value.repo) @ \(.value.branch)"' \
    "$JOURNAL/state/ACTIVE_SESSIONS.json" || true
}

cmd_up(){
  need jq; need gh
  ensure_journal

  COUNT=$(jq '.sessions|length' "$JOURNAL/state/ACTIVE_SESSIONS.json")
  [ "$COUNT" -eq 0 ] && die "セッションなし。まずどこかで dev stop を1回実行"

  CHOICE="${1:-}"
  [ -z "$CHOICE" ] && die "Claude Codeでは必ず番号指定: dev up 1"

  IDX=$((CHOICE-1))
  REPO=$(jq -r ".sessions[$IDX].repo" "$JOURNAL/state/ACTIVE_SESSIONS.json")
  BRANCH=$(jq -r ".sessions[$IDX].branch" "$JOURNAL/state/ACTIVE_SESSIONS.json")

  ok "Resume: $REPO @ $BRANCH"

  if [ ! -d "$DEV/$REPO/.git" ]; then
    cd "$DEV"
    gh repo clone "$ORG/$REPO" "$DEV/$REPO" || die "clone失敗"
  fi

  cd "$DEV/$REPO"
  git fetch --all --prune 2>/dev/null || true
  git checkout "$BRANCH" 2>/dev/null || git checkout -b "$BRANCH" "origin/$BRANCH" || true

  touch "$SESSION_FLAG"
  ok "Started. Finish with: dev stop"
  git status --short
}

cmd_stop(){
  need jq

  # ✅ capture WORK repo BEFORE journal cd
  WORK_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) \
    || die "プロジェクト内で dev stop を実行してください"

  WORK_REPO=$(basename "$WORK_ROOT")
  WORK_BRANCH=$(git -C "$WORK_ROOT" branch --show-current)
  WORK_HEAD=$(git -C "$WORK_ROOT" rev-parse --short HEAD)
  TS=$(now)

  ensure_journal

  SNAP="${TS}_${WORK_REPO}_${WORK_HEAD}"
  DIR="$JOURNAL/snapshots/$SNAP"
  mkdir -p "$DIR"

  git -C "$WORK_ROOT" diff > "$DIR/diff.patch" 2>/dev/null || true

  tmp=$(mktemp)
  jq --arg ts "$TS" --arg repo "$WORK_REPO" --arg br "$WORK_BRANCH" --arg snap "$SNAP" \
    '.sessions=[{"timestamp":$ts,"repo":$repo,"branch":$br,"snapshot":$snap}] + .sessions[:19]' \
    "$JOURNAL/state/ACTIVE_SESSIONS.json" > "$tmp" && mv "$tmp" "$JOURNAL/state/ACTIVE_SESSIONS.json"

  journal_push
  rm -f "$SESSION_FLAG"

  ok "Saved: $WORK_REPO @ $WORK_BRANCH"
  ok "Next: dev up 1"
}

case "${1:-}" in
  up)     cmd_up "$2" ;;
  stop)   cmd_stop ;;
  list)   cmd_list ;;
  *)      usage ;;
esac
