#!/bin/bash
set -eo pipefail

ORG="aesthetic-inc"
DEV="$HOME/dev"
JOURNAL="$DEV/dev-journal"
SESSION_FLAG="$HOME/.devos_active"

die(){ echo "❌ $*" >&2; exit 1; }
ok(){ echo "✅ $*"; }
warn(){ echo "⚠️  $*"; }

need(){ command -v "$1" >/dev/null 2>&1 || die "$1 が必要です"; }

now(){ TZ=Asia/Tokyo date +"%Y-%m-%d_%H-%M-%S"; }

ensure_journal(){
  mkdir -p "$DEV"
  if [ ! -d "$JOURNAL/.git" ]; then
    echo "⚠️  dev-journal not found. Auto-bootstrapping..."
    command -v gh >/dev/null 2>&1 || die "gh が必要です: brew install gh"
    gh auth status >/dev/null 2>&1 || die "GitHub未ログイン: gh auth login"
    cd "$DEV"
    gh repo clone "$ORG/dev-journal" "$JOURNAL" || die "dev-journal clone失敗"
  fi
  cd "$JOURNAL"
  git pull --rebase 2>/dev/null || true
  mkdir -p state logs snapshots
  [ -f state/ACTIVE_SESSIONS.json ] || echo '{"sessions":[]}' > state/ACTIVE_SESSIONS.json
}

journal_push(){
  cd "$JOURNAL"
  git add -A
  git commit -m "session: update" 2>/dev/null || true
  git push || die "journal push失敗（保存されていない）"
}

usage(){
  cat <<USAGE
DevOS v1.9

Start:
  dev up 1     ← 毎朝これだけ

End:
  dev stop     ← 絶対これだけ
USAGE
}

cmd_list(){
  need jq; ensure_journal
  echo "=== Sessions ==="
  jq -r '.sessions[:10] | to_entries[] |
    "\(.key+1)) \(.value.timestamp)  \(.value.repo) @ \(.value.branch)"' \
    "$JOURNAL/state/ACTIVE_SESSIONS.json" || true
}

cmd_up(){
  need jq; need gh
  ensure_journal

  COUNT=$(jq '.sessions|length' "$JOURNAL/state/ACTIVE_SESSIONS.json")
  [ "$COUNT" -eq 0 ] && die "セッションなし。まずどこかで dev stop を1回実行"

  CHOICE="${1:-}"
  [ -z "$CHOICE" ] && CHOICE=1

  IDX=$((CHOICE-1))
  REPO=$(jq -r ".sessions[$IDX].repo" "$JOURNAL/state/ACTIVE_SESSIONS.json")
  BRANCH=$(jq -r ".sessions[$IDX].branch" "$JOURNAL/state/ACTIVE_SESSIONS.json")

  ok "Resume: $REPO @ $BRANCH"

  if [ ! -d "$DEV/$REPO/.git" ]; then
    cd "$DEV"
    gh repo clone "$ORG/$REPO" "$DEV/$REPO" || die "clone失敗"
  fi

  cd "$DEV/$REPO"
  git fetch --all --prune 2>/dev/null || true
  git pull --ff-only 2>/dev/null || echo "⚠️  Pull skipped (non-fast-forward) — run git pull manually"
  git checkout "$BRANCH" 2>/dev/null || git checkout -b "$BRANCH" "origin/$BRANCH" || true

  touch "$SESSION_FLAG"
  ok "Started. Finish with: dev stop"
  git status --short
}

cmd_stop(){
  need jq

  # ✅ capture WORK repo BEFORE journal cd
  WORK_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) \
    || die "プロジェクト内で dev stop を実行してください"

  WORK_REPO=$(basename "$WORK_ROOT")
  WORK_BRANCH=$(git -C "$WORK_ROOT" branch --show-current)
  WORK_HEAD=$(git -C "$WORK_ROOT" rev-parse --short HEAD)
  TS=$(now)

  ensure_journal

  SNAP="${TS}_${WORK_REPO}_${WORK_HEAD}"
  DIR="$JOURNAL/snapshots/$SNAP"
  mkdir -p "$DIR"

  git -C "$WORK_ROOT" diff > "$DIR/diff.patch" 2>/dev/null || true

  tmp=$(mktemp)
  jq --arg ts "$TS" --arg repo "$WORK_REPO" --arg br "$WORK_BRANCH" --arg snap "$SNAP" \
    '.sessions=[{"timestamp":$ts,"repo":$repo,"branch":$br,"snapshot":$snap}] + .sessions[:19]' \
    "$JOURNAL/state/ACTIVE_SESSIONS.json" > "$tmp" && mv "$tmp" "$JOURNAL/state/ACTIVE_SESSIONS.json"

  journal_push
  rm -f "$SESSION_FLAG"

  ok "Saved: $WORK_REPO @ $WORK_BRANCH"
  ok "Next: dev up 1"
}

# ============================================
# doctor (healthcheck)
# ============================================
cmd_doctor(){
  echo "=== DevOS doctor ==="

  echo -n "git: "; command -v git >/dev/null && echo "OK" || echo "MISSING"
  echo -n "gh:  "; command -v gh  >/dev/null && echo "OK" || echo "MISSING"
  echo -n "jq:  "; command -v jq  >/dev/null && echo "OK" || echo "MISSING"

  echo -n "gh auth: "
  gh auth status >/dev/null 2>&1 && echo "OK" || echo "LOGIN REQUIRED"

  echo -n "dev-journal: "
  [ -d "$HOME/dev/dev-journal/.git" ] && echo "OK" || echo "NOT CLONED"

  echo -n "sessions: "
  if [ -f "$HOME/dev/dev-journal/state/ACTIVE_SESSIONS.json" ]; then
    jq '.sessions|length' "$HOME/dev/dev-journal/state/ACTIVE_SESSIONS.json"
  else
    echo "0"
  fi
}

# ============================================
# v1.6 language config
# ============================================
CONFIG="$HOME/.devos_config.json"

load_lang(){
  if [ -f "$CONFIG" ]; then
    LANG_MODE=$(jq -r '.lang // "ja"' "$CONFIG" 2>/dev/null || echo "ja")
  else
    LANG_MODE="ja"
  fi
}

set_lang(){
  mkdir -p "$(dirname "$CONFIG")"
  echo "{\"lang\":\"$1\"}" > "$CONFIG"
  echo "✅ Language set to: $1"
}

cmd_start(){
  cmd_up "$1"
}

cmd_lang(){
  case "${1:-}" in
    ja|en) set_lang "$1" ;;
    *) echo "Usage: dev lang ja|en" ;;
  esac
}

# ============================================
# v1.7 last project auto-resume (human-safe)
# ============================================
PROJECT_STATE="$HOME/.devos_project.json"

get_last_project(){
  if [ -f "$PROJECT_STATE" ]; then
    jq -r '.last // ""' "$PROJECT_STATE" 2>/dev/null || echo ""
  else
    echo ""
  fi
}

set_last_project(){
  local proj="$1"
  echo "{\"last\":\"$proj\"}" > "$PROJECT_STATE"
}

list_projects(){
  echo "=== Projects ==="
  for d in "$DEV"/*/; do
    [ -d "$d/.git" ] && echo "- $(basename "$d")"
  done
}

# v1.7 start: open last project automatically
cmd_start_v17(){
  local proj="${1:-$(get_last_project)}"

  if [ -z "$proj" ]; then
    echo "❌ No last project yet."
    echo "First time only: dev start <project>"
    list_projects
    return 1
  fi

  if [ ! -d "$DEV/$proj/.git" ]; then
    echo "❌ Project missing: $proj"
    list_projects
    return 1
  fi

  cd "$DEV/$proj"
  cmd_up
}

# v1.7 stop hook: remember last project automatically
cmd_stop_v17(){
  local proj
  proj=$(basename "$(pwd)")

  cmd_stop

  if [ -d "$DEV/$proj/.git" ]; then
    set_last_project "$proj"
    echo "✅ Last project remembered: $proj"
  fi
}

# ============================================
# v1.8 multi-project session management (SAFE)
# ============================================

ACTIVE="$JOURNAL/state/ACTIVE_SESSIONS.json"

# repo別に最新セッションだけ抽出（ts基準）
get_project_sessions(){
  jq -r '
    [.sessions
      | map(select(.repo != "dev-journal"))
      | group_by(.repo)
      | .[]
      | max_by(.ts)
    ]
    | sort_by(.ts)
    | reverse
    | .[]
    | "\(.repo)|\(.branch)|\(.ts)"
  ' "$ACTIVE" 2>/dev/null
}

# 一覧表示
list_last_sessions(){
  echo "=== Last Sessions ==="
  local i=1
  get_project_sessions | while IFS='|' read -r repo branch ts; do
    echo "$i) $repo @ $branch"
    i=$((i+1))
  done
  echo ""
  echo "Run: dev start <number or name>"
}

# index→repo取得
get_repo_by_index(){
  local idx="$1"
  get_project_sessions | sed -n "${idx}p" | cut -d'|' -f1
}

# repoの最新セッション番号をACTIVEから探す
get_session_index_for_repo(){
  local repo="$1"
  jq -r --arg repo "$repo" '
    .sessions
    | to_entries
    | map(select(.value.repo==$repo))
    | sort_by(.value.ts) | reverse
    | .[0].key + 1
  ' "$ACTIVE"
}

# v1.8 start
cmd_start_v18(){
  ensure_journal

  local arg="${1:-}"

  # 引数なし → 一覧だけ出す
  if [ -z "$arg" ]; then
    list_last_sessions
    return 0
  fi

  local target_repo=""

  # 数字ならindex選択
  if [[ "$arg" =~ ^[0-9]+$ ]]; then
    target_repo=$(get_repo_by_index "$arg")
    [ -z "$target_repo" ] && echo "❌ Invalid number" && list_last_sessions && return 1
  else
    target_repo="$arg"
  fi

  # repo存在確認
  if [ ! -d "$DEV/$target_repo/.git" ]; then
    echo "❌ Project not found: $target_repo"
    list_last_sessions
    return 1
  fi

  # そのrepoの最新セッションIDを取得
  local sid
  sid=$(get_session_index_for_repo "$target_repo")

  if [ -z "$sid" ] || [ "$sid" = "null" ]; then
    echo "❌ No session found for $target_repo"
    return 1
  fi

  echo "✅ Resume: $target_repo (session $sid)"

  cd "$DEV/$target_repo"
  cmd_up "$sid"
}

# ============================================
# dispatch
# ============================================
case "${1:-}" in
  start)  cmd_start_v18 "$2" ;;
  lang)   cmd_lang "$2" ;;
  doctor) cmd_doctor ;;
  up)     cmd_up "$2" ;;
  stop)   cmd_stop_v17 ;;
  list)   cmd_list ;;
  *)      usage ;;
esac
